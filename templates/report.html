<!DOCTYPE html>
<html>
  <head>
    <title>Api Benchmark :: report</title>
    <!--[if lt IE 9]><script src="https://cdnjs.cloudflare.com/ajax/libs/jqPlot/1.0.8/excanvas.min.js"></script><![endif]-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqPlot/1.0.8/jquery.jqplot.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqPlot/1.0.8/plugins/jqplot.canvasTextRenderer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqPlot/1.0.8/plugins/jqplot.canvasAxisLabelRenderer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqPlot/1.0.8/plugins/jqplot.highlighter.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqPlot/1.0.8/jquery.jqplot.min.css" type="text/css" />

    <style type="text/css">
      .jqplot-target {
        color: #F1F1F1;
      }
      table.jqplot-table-legend, table.jqplot-cursor-legend {
        background-color: rgba(101, 0, 253, 0.89)
      }

      body {
        background: #3D3D3D;
        color: #F1F1F1;
      }

      a {
        color: #6699FF;
      }

      #report-details, #charts {
        width: 100%;
        float: left;
        font-family: "Trebuchet MS",Arial,Helvetica,sans-serif;
      }

      #report-details {
        margin-bottom: 20px;
        text-align: center;
      }

      .chart {
        width: 60%;
        height: 450px;
        float: left;
      }
      .route {
        width: 90%;
        margin: 3%;
        padding: 2%;
        float: left;
        background-color: #000000;
        border-radius: 15px;
      }
      .route-details {
        font-family: "Trebuchet MS",Arial,Helvetica,sans-serif;
        font-size: 1em;
        float: left;
        width: 36%;
        padding: 2%;
      }

      .green {
        color: green;
      }

      .red {
        color: red;
      }
    </style>
  </head>
  <body>
    <script>var data={{ data }};</script>
    <div id="report">
      <div id="report-details"><h1>Api Benchmark report</h1></div>
      <div id="charts"></div>
    </div>
    <div style="text-align: center">
    Generated by <a href="https://github.com/matteofigus/api-benchmark" target="_blank">api-benchmark</a><br /><br />
    <iframe src="http://ghbtns.com/github-btn.html?user=matteofigus&repo=grunt-api-benchmark&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="110" height="20"></iframe>
    </div>
    <script>

      var selectors = {
        charts: "#charts",
        reportDetails: "#report-details"
      };

      var formatNumber = function(number) {
        number = String(number).split('.');
        return number[0].replace(/(?=(?:\d{3})+$)(?!\b)/g, ',') +
          (number[1] ? '.' + number[1] : '');
      };

      var formatDate = function(date){
        return date.replace(/T/g, ' ').replace(/Z/g, ' ');
      };

      var fixNumber = function(number, digits){
        return formatNumber(number.toFixed(digits));
      };

      var templates = {
        reportDetails: function(info){
          var formattedDate = formatDate(info.date);
          return "Benchmarked " + info.apiName + " on " + formattedDate;
        },
        route: function(routeData, i){
          var errorsCount = 0,
              errorsDesc = "(",
              duration = (new Date(routeData.options.end) - new Date(routeData.options.start))/1e3;

          for(var errorType in routeData.errors){
            errorsCount += routeData.errors[errorType].length;
            errorsDesc += routeData.errors[errorType].length + ' ' + errorType + ',';
          }

          if(errorsCount == 0)
            errorsDesc = '';
          else
            errorsDesc = errorsDesc.substr(0, errorsDesc.length - 1) + ')';

          var template = "<div class=\"route\"><div class=\"chart\" id=\"chart" + i + "\"></div>" +
            "<div class=\"route-details\"><ul>" +
            "<li><a href=\"" + routeData.href + "\" target=\"_blank\">" + routeData.href + "</a></li>" +

            "<li>" + routeData.stats.sample.length + " run" +
            (routeData.stats.sample.length > 1 ? "s" : "") + " sampled </li>" +

            "<li>Concurrency level: " + routeData.options.concurrencyLevel + "</li>";

          if(routeData.options.delay)
            template += "<li>Delay between bench cycles: " + routeData.options.delay + "</li>";

          if(routeData.options.expectedStatusCode)
            template += "<li>Expected status code: " + routeData.options.expectedStatusCode + "</li>";

          if(routeData.options.maxMean)
            template += "<li>Expected max mean: " + routeData.options.maxMean + "</li>";

          if(routeData.options.maxSingleMean)
            template += "<li>(*) Expected max mean across all concurrent requests: " + routeData.options.maxSingleMean + "</li>";

          template += "</ul><ul><li>Started: " + formatDate(routeData.options.start) + "</li>" +
            "<li>Ended: " + formatDate(routeData.options.end) + " (" + duration + " seconds)</li>" +
            "<li>" + fixNumber(routeData.hz, 2) + " ops/sec \xb1 " + fixNumber(routeData.stats.rme, 2) + "%</li>" +

            "<li class=\"" + (!errorsCount ? 'green' : 'red') + "\">" + errorsCount + " error" +
            (errorsCount == 1 ? "" : "s") + " " + errorsDesc + "</li>" +

            "<li>Sample arithmetic mean: " + fixNumber(routeData.stats.mean, 6) + "</li>";

          if(routeData.options.concurrencyLevel > 1)
            template += "<li>Mean across all the concurrent requests: " + fixNumber(routeData.stats.singleMean, 6) + "</li>";

          template += "<li>Sample standard deviation: " + fixNumber(routeData.stats.deviation, 6) + "</li>" +
            "<li>Margin of error: " + fixNumber(routeData.stats.moe, 6) + "</li>" +
            "<li>The standard error of the mean: " + fixNumber(routeData.stats.sem, 6) + "</li>" +
            "<li>The sample variance: " + fixNumber(routeData.stats.variance, 6) + "</li>" +
            "</ul></div></div>";

          return template;
        }
      };

      $(function(){
        $(selectors.reportDetails).append(templates.reportDetails(data.info));

        var counter = 0;
        for(serviceName in data.benchmark){
          for(routeName in data.benchmark[serviceName]){
            $(selectors.charts).append(templates.route(data.benchmark[serviceName][routeName], counter));

            var samples = data.benchmark[serviceName][routeName]['stats']['sample'],
                meanArray = [],
                mean = data.benchmark[serviceName][routeName]['stats']['mean'],
                singleMeanArray = [],
                singleMean = data.benchmark[serviceName][routeName]['stats']['singleMean'],
                maxMeanArray = [],
                maxMean = data.benchmark[serviceName][routeName].options.maxMean !== undefined,
                maxSingleMeanArray = [],
                maxSingleMean = data.benchmark[serviceName][routeName].options.maxSingleMean !== undefined,
                errorsArray = [],
                areThereSomeErrors = false;

            for(var i = 0; i < samples.length; i++){
              meanArray.push(mean);
              singleMeanArray.push(singleMean);

              errorsArray.push(null);

              if(maxMean)
                maxMeanArray.push(data.benchmark[serviceName][routeName].options.maxMean);

              if(maxSingleMean)
                maxSingleMeanArray.push(data.benchmark[serviceName][routeName].options.maxSingleMean);
            }

            for(var errorType in data.benchmark[serviceName][routeName].errors){
              var errorsOfType = data.benchmark[serviceName][routeName]['errors'][errorType];
              for(var i = 0; i < errorsOfType.length; i++){
                if(errorsOfType[i].pos !== undefined){
                  errorsArray[errorsOfType[i].pos] = data.benchmark[serviceName][routeName]['stats']['sample'][errorsOfType[i].pos];
                  areThereSomeErrors = true;
                }
              }
            }

            var getSeriesOptions = function(label, color){
              return {
                showMarker: false,
                pointLabels: { show: true },
                label: label,
                color: color
              };
            };

            var lines = [samples],
                series = [getSeriesOptions('Samples', '#6699FF')];

            if(maxMean){
              lines.push(maxMeanArray);
              series.push(getSeriesOptions('Max Mean', '#F90'));
            }

            lines.push(meanArray);
            series.push(getSeriesOptions('Mean', '#66FF00'));

            if(maxSingleMean){
              lines.push(maxSingleMeanArray);
              series.push(getSeriesOptions('Max Single Mean (*)', '#EBFF00'));

              lines.push(singleMeanArray);
              series.push(getSeriesOptions('Single mean', '#FC6333'));
            }

            if(areThereSomeErrors > 0){
              lines.push(errorsArray);
              series.push({
                showLine:false,
                markerOptions: { size: 7, style:"x" },
                label: 'Errors',
                color: '#FF0000'
              });
            }

            var options = {
              title: {
                text: data.benchmark[serviceName][routeName]['name'],
                color: '#F1F1F1'
              },
              animate: true,
              grid: {
                background: '#000000', textColor: '#F1F1F1'
              },
              seriesDefaults:{
                rendererOptions: {
                  showDataLabels: true
                }
              },
              highlighter: {
                show: true,
                sizeAdjust: 7.5
              },
              legend: {
                show:true,
                location: 'se',
                background: 'rgba(101, 0, 253, 0.89)'
              },
              axesDefaults: {
                labelRenderer: $.jqplot.CanvasAxisLabelRenderer
              },
              axes: {
                xaxis: {
                  label: "Samples",
                  pad: 0
                },
                yaxis: {
                  label: "Response time (seconds)",
                  tickOptions: {
                    formatString:'%.6f'
                  }
                }
              },
              series: series
            };

            var plot = $.jqplot('chart' + counter, lines, options);
            counter++;
          }
        }
      });
    </script>
  </body>
</html>
